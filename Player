from mfrc522 import SimpleMFRC522
import RPi.GPIO as GPIO
import spotipy
from spotipy.oauth2 import SpotifyOAuth
from time import sleep
import json

DEVICE_ID = "YOUR_DEVICE_ID"
CLIENT_ID = "YOUR_CLIENT_ID"
CLIENT_SECRET = "YOUR_CLIENT_SECRET"

try:
    # Initialize the RFID reader and Spotify client
    reader = SimpleMFRC522()
    sp = spotipy.Spotify(auth_manager=SpotifyOAuth(client_id=CLIENT_ID,
                                                   client_secret=CLIENT_SECRET,
                                                   redirect_uri="http://localhost:8080",
                                                   scope="user-read-playback-state,user-modify-playback-state"))

    while True:
        try:
            print("Waiting for scan")
            id = reader.read()[0]

            # Ensure the Spotify device is active
            sp.transfer_playback(device_id=DEVICE_ID, force_play=False)
            sleep(1)  # Give some time for the transfer to complete

            with open("AssignedTags.json", "r") as file:
                data = json.load(file)

            if str(id) not in data:
                print(f"ID {id} not recognized!")
            else:
                uris = data[str(id)]
                sp.start_playback(device_id=DEVICE_ID, uris=[uris])
                print(f"Playing: {uris}")
                sleep(2)  # Wait a bit before next scan

        except Exception as e:
            print(f"Error: {e}")
            sleep(1)  # Wait a bit before retrying

except KeyboardInterrupt:
    print("Program interrupted by user")

finally:
    print("Cleaning up...")
    GPIO.cleanup()